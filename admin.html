<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Panel UPDATED AGAIN</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body{font-family:system-ui,Arial;text-align:center;padding:28px;}
  input{padding:10px 12px;border:1px solid #ccc;border-radius:12px;width:min(340px,90vw);margin:6px;}
  button{padding:10px 14px;border-radius:12px;border:1px solid #ccc;background:#fff;font-weight:700;cursor:pointer;margin:6px;}
  .primary{background:#111;color:#fff;border-color:#111;}
  .card{max-width:700px;margin:0 auto;border:1px solid #eee;border-radius:16px;padding:18px;box-shadow:0 10px 28px rgba(0,0,0,.06);}
  #error{color:#b00020;font-weight:800;white-space:pre-wrap;margin-top:10px;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;vertical-align:top;}
</style>
</head>

<body>
<div class="card">
  <h1 style="margin:0 0 10px;">Admin</h1>

  <div id="loginBox">
    <div style="font-weight:700;margin-bottom:6px;">Log in</div>
    <input id="email" placeholder="email" />
    <br/>
    <input id="password" type="password" placeholder="password" />
    <br/>
    <button class="primary" id="loginBtn">Login</button>
  </div>

  <div id="adminBox" style="display:none;">
    <h2 id="status" style="margin:10px 0 6px;">‚Äî</h2>
    <button class="primary" id="toggleBtn">Toggle Status</button>
    <button id="logoutBtn">Logout</button>

    <h3 style="margin:18px 0 8px;">Requests</h3>
    <table id="reqTable"></table>
  </div>

  <div id="error"></div>
</div>

<script>
  const SUPABASE_URL = "https://vssilapltdpdwulsqtma.supabase.co";
  const SUPABASE_KEY = "sb_publishable_06j9641qX6bJ0Q0GCONGrw_G6Pa5UrP";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  function setError(msg) {
    document.getElementById("error").textContent = msg || "";
  }

  // ----- LIVE channels -----
  let statusChannel = null;
  let requestsChannel = null;

  function startLiveAdmin() {
    if (statusChannel || requestsChannel) return; // don‚Äôt double-subscribe

    statusChannel = sb
      .channel("admin-status-live")
      .on(
        "postgres_changes",
        { event: "UPDATE", schema: "public", table: "app_status" },
        () => refreshAdmin()
      )
      .subscribe();

    requestsChannel = sb
      .channel("admin-requests-live")
      .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "requests" },
        () => refreshAdmin()
      )
      .subscribe();
  }

  function stopLiveAdmin() {
    if (statusChannel) sb.removeChannel(statusChannel);
    if (requestsChannel) sb.removeChannel(requestsChannel);
    statusChannel = null;
    requestsChannel = null;
  }

  async function refreshAdmin() {
    setError("");

    // STATUS
    const statusRes = await sb.from("app_status").select("*").eq("id", 1).single();
    if (statusRes.error) {
      setError("Status read error: " + statusRes.error.message);
      return;
    }

    document.getElementById("status").innerText =
      statusRes.data.is_available ? "üôÇ Any time" : "üôÅ Busy";

    // REQUESTS
    const reqRes = await sb.from("requests")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(50);

    if (reqRes.error) {
      setError("Requests read error: " + reqRes.error.message);
      return;
    }

    const t = document.getElementById("reqTable");
    t.innerHTML = `
      <tr>
        <th>Time</th><th>Selected</th><th>Other</th><th>Status</th>
      </tr>
    `;

    (reqRes.data || []).forEach(r => {
      const selected = Array.isArray(r.selected_keys)
        ? r.selected_keys.join(", ")
        : JSON.stringify(r.selected_keys);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${selected}</td>
        <td>${r.other_text ?? ""}</td>
        <td>${r.status_at_time}</td>
      `;
      t.appendChild(tr);
    });
  }

  async function updateUI() {
    const { data } = await sb.auth.getSession();
    const authed = !!data.session;

    document.getElementById("loginBox").style.display = authed ? "none" : "block";
    document.getElementById("adminBox").style.display = authed ? "block" : "none";

    if (authed) {
      startLiveAdmin();      // ‚úÖ start realtime listeners
      await refreshAdmin();  // ‚úÖ initial load
    } else {
      stopLiveAdmin();       // ‚úÖ stop listeners on logout
    }
  }

  document.getElementById("loginBtn").onclick = async () => {
    setError("");
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    const res = await sb.auth.signInWithPassword({ email, password });
    if (res.error) setError("Login error: " + res.error.message);

    await updateUI();
  };

  document.getElementById("logoutBtn").onclick = async () => {
    await sb.auth.signOut();
    await updateUI();
  };

  document.getElementById("toggleBtn").onclick = async () => {
    setError("");

    const cur = await sb.from("app_status").select("*").eq("id", 1).single();
    if (cur.error) {
      setError("Toggle read error: " + cur.error.message);
      return;
    }

    const upd = await sb.from("app_status")
      .update({ is_available: !cur.data.is_available, updated_at: new Date().toISOString() })
      .eq("id", 1);

    if (upd.error) {
      setError("Toggle update error: " + upd.error.message);
      return;
    }

    await refreshAdmin();
  };

  updateUI();
</script>
</body>
</html>
