<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Status Check</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: system-ui, Arial; text-align: center; padding: 40px; }
    h1 { font-size: 56px; margin: 0 0 20px; }
    #buttons { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #ccc; background: #fff; font-weight: 700; cursor: pointer; }
    button.selected { background: #e7e7e7; border-color: #111; }
    #sendBtn { margin-top: 18px; padding: 12px 18px; }
    #error { color: #b00020; font-weight: 800; margin-top: 14px; white-space: pre-wrap; min-height: 1.2em; }
  </style>

  <script>
    const SUPABASE_URL = "https://vssilapltdpdwulsqtma.supabase.co";
    const SUPABASE_KEY = "sb_publishable_06j9641qX6bJ0Q0GCONGrw_G6Pa5UrP"; // <-- paste your publishable key

    // global client
    window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    window.selectedKeys = new Set();
    window.otherText = "";

    function setError(msg) {
      const el = document.getElementById("error");
      el.textContent = msg || "";
    }

    function updateSendEnabled() {
      const sendBtn = document.getElementById("sendBtn");
      sendBtn.disabled = window.selectedKeys.size === 0;
    }

    async function load() {
      setError("");

      // STATUS
      const statusRes = await window.sb.from("app_status").select("*").eq("id", 1).single();
      if (statusRes.error) { setError("Status error: " + statusRes.error.message); return; }

      const isAvail = !!statusRes.data.is_available;
      document.getElementById("status").innerText = isAvail ? "ðŸ™‚ Any time" : "ðŸ™ Busy";

      // BUTTONS
      const btnRes = await window.sb
        .from("buttons")
        .select("*")
        .eq("active", true)
        .order("sort_order", { ascending: true });

      if (btnRes.error) { setError("Buttons error: " + btnRes.error.message); return; }

      const container = document.getElementById("buttons");
      container.innerHTML = "";

      btnRes.data.forEach(b => {
        const btn = document.createElement("button");
        btn.textContent = b.label;
        btn.dataset.key = b.key;

        if (window.selectedKeys.has(b.key)) btn.classList.add("selected");

        btn.onclick = () => {
          // toggle off
          if (window.selectedKeys.has(b.key)) {
            window.selectedKeys.delete(b.key);
            if (b.key === "other") window.otherText = "";
            btn.classList.remove("selected");
            updateSendEnabled();
            return;
          }

          // selecting on
          if (b.needs_text) {
            const txt = prompt("What other thing? (optional)");
            if (txt === null) return; // cancel => do not select
            window.otherText = txt;   // can be empty
          }

          window.selectedKeys.add(b.key);
          btn.classList.add("selected");
          updateSendEnabled();
        };

        container.appendChild(btn);
      });

      updateSendEnabled();
    }

    async function sendRequest() {
      setError("");

      if (window.selectedKeys.size === 0) {
        setError("Select at least one option before sending.");
        return;
      }

      const statusRes = await window.sb.from("app_status").select("*").eq("id", 1).single();
      if (statusRes.error) { setError("Status error: " + statusRes.error.message); return; }

      const statusAtTime = statusRes.data.is_available ? "any_time" : "busy";

      const ins = await window.sb.from("requests").insert({
        selected_keys: Array.from(window.selectedKeys),
        other_text: window.selectedKeys.has("other") ? (window.otherText || null) : null,
        status_at_time: statusAtTime
      });

      if (ins.error) { setError("Send error: " + ins.error.message); return; }

      // reset state + visuals
      window.selectedKeys.clear();
      window.otherText = "";
      document.querySelectorAll("#buttons button").forEach(b => b.classList.remove("selected"));
      updateSendEnabled();

      // reload UI
      await load();

      // success message briefly
      setError("Sent âœ…");
      setTimeout(() => setError(""), 1200);
    }

    // expose
    window.load = load;
    window.sendRequest = sendRequest;
  </script>
</head>

<body onload="load()">
  <h1 id="status">Loadingâ€¦</h1>
  <div id="buttons"></div>

  <div>
    <button id="sendBtn" onclick="sendRequest()" disabled>Send</button>
  </div>

  <div id="error"></div>
</body>
</html>
